<html>
<head>

	<meta charset="UTF-8">
	<title>Image Swizzle</title>

	<link rel="stylesheet" href="../shared/shared.css">
	
	<link rel="stylesheet" href="../shared/third-party/jquery/jquery-ui.min.css">
	<script src="../shared/third-party/jquery/external/jquery/jquery.js"></script>
	<script src="../shared/third-party/jquery/jquery-ui.min.js"></script>

	<style>
	.panel
	{
		border: 2px solid grey;
		background-color:white;
		padding:10px;
		width:1020px;
		overflow:hidden;
		border-radius:10px;
		padding-left:10px;
		padding-right:10px;
	}
	#file_input
	{
		font-family: 'Roboto', sans-serif;
		margin-left:30px;
		border-left:2px solid grey;
		margin-right:30px;
		border-right:2px solid grey;
		padding-left:36px;
		padding-right:36px;
		border-radius:0px;
		max-width:280px;
	}
	#canvas
	{
		visibility:hidden;
	}
	</style>

	<script language="javascript">
	var inputFile = "";
	var maxCanvasHeight = 560;

	function onBodyLoaded()
	{
		$("select").selectmenu({ width: "80px"}).on('selectmenuchange', function() { updateCanvas(); });
		$("#scale_select").selectmenu({ width: "150px"}).on('selectmenuchange', function() { updateCanvas(); });
	}

	function onFileSelected(file)
	{
		var reader = new FileReader();
		reader.onload = function (e) { inputFile = e.target.result; updateCanvas(); }
		reader.readAsDataURL(file);
	}

	function updateCanvas()
	{
		// Grab canvas
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');

		// Load image
		var img = new Image();
		img.src = inputFile;
		
		// When image loaded...
		img.onload = function()
		{
			// Hide image
			img.style.display = 'none';

			// Copy image to canvas
			var shrinkToFit = ($("#scale_select").val() == "shrink");
			var canvasScaleFactor = (shrinkToFit && (img.height > maxCanvasHeight))? (maxCanvasHeight / img.height) : 1.0;
			canvas.width = img.width * canvasScaleFactor;
			canvas.height = img.height* canvasScaleFactor;
			ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

			// Grab swizzle indices
			var getSwizzleIndex = function(element)
			{
				switch($(element).val()) { case "R": return 0; case "G": return 1; case "B": return 2; case "A": return 3; }
			}
			var r_swizzleIndex = getSwizzleIndex("#r_select");
			var g_swizzleIndex = getSwizzleIndex("#g_select");
			var b_swizzleIndex = getSwizzleIndex("#b_select");
			var a_swizzleIndex = getSwizzleIndex("#a_select");

			// Grab pixel buffer
			var imageData = ctx.getImageData(0, 0, img.width, img.height);
			var pixels = imageData.data;

			// Perform swizzle on pixel buffer
			for(var x = 0; x < img.width; ++x)
			{
				var colIndex = (x * img.height * 4);
				for(var y = 0; y < img.height; ++y)
				{
					var rowIndex = (y * 4);
					var pixelIndex = colIndex + rowIndex;
					var pixelCopy = [pixels[pixelIndex + 0], pixels[pixelIndex + 1], pixels[pixelIndex + 2], pixels[pixelIndex + 3]];
					pixels[pixelIndex + 0] = pixelCopy[ r_swizzleIndex ]; // Swizzle R
					pixels[pixelIndex + 1] = pixelCopy[ g_swizzleIndex ]; // Swizzle G
					pixels[pixelIndex + 2] = pixelCopy[ b_swizzleIndex ]; // Swizzle B
					pixels[pixelIndex + 3] = pixelCopy[ a_swizzleIndex ]; // Swizzle A
				}
			}

			// Store pixel buffer back to canvas
			ctx.putImageData(imageData, 0, 0, 0, 0, canvas.width, canvas.height);
			canvas.style.visibility = "visible";
		};
	}
	</script>
</head>

<body onload="onBodyLoaded()">
	<div class="panel">
		R = <select id="r_select">
		<option value="R" selected="selected">R</option>
		<option value="G">G</option>
		<option value="B">B</option>
		<option value="A">A</option>
		</select>
		G = <select id="g_select">
		<option value="R">R</option>
		<option value="G" selected="selected">G</option>
		<option value="B">B</option>
		<option value="A">A</option>
		</select>
		B = <select id="b_select">
		<option value="R">R</option>
		<option value="G">G</option>
		<option value="B" selected="selected">B</option>
		<option value="A">A</option>
		</select>
		A = <select id="a_select">
		<option value="R">R</option>
		<option value="G">G</option>
		<option value="B">B</option>
		<option value="A" selected="selected">A</option>
		</select>
		<input type="file" id="file_input" onchange="onFileSelected(this.files[0])"/>
		Scaling = <select id="scale_select">
			<option value="shrink">Shrink to fit</option>
			<option value="original">Original size</option>
		</select>
	</div>
	<br/>
	<canvas id="canvas" width="0" height="0"></canvas>
</body>

</html>